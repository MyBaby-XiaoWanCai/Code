/**********************************************************************************************************
** Company     : JNE WuHan Co.,Ltd.
** Project     :
** --------------------------------------------------------------------------------------------------------
** File name   : bsp_dwt.c
** Author      : Huang Cheng
** Date        : 2021-11-12
** Description : bsp_dwt source file
**********************************************************************************************************/

/**********************************************************************************************************
**                                          头文件引用区
**********************************************************************************************************/
#include "bsp_dwt.h"

/**********************************************************************************************************
**                                         全局变量定义区
**********************************************************************************************************/


/**********************************************************************************************************
**                                           函数声明区
**********************************************************************************************************/


/**********************************************************************************************************
**                                           应用函数区
**********************************************************************************************************/

/**********************************************************************************************************
**	函 数 名 : bsp_InitDWT()
**	功能说明 : 初始化DWT, 该函数被bsp_Init()调用
**	形    参 : 无
**	返 回 值 : 无
**********************************************************************************************************/
void bsp_InitDWT(void)
{
    DEM_CR    |= (unsigned int)DEM_CR_TRCENA;		/* Enable Cortex-M's DWT CYCCNT reg. */
    DWT_CYCCNT = (unsigned int)0u;
    DWT_CR    |= (unsigned int)DWT_CR_CYCCNTENA;
}

/**********************************************************************************************************
**	函 数 名 : bsp_DelayMS()
**	功能说明 : 为了让底层驱动在带RTOS和裸机情况下有更好的兼容性，专门制作一个阻塞式的延迟函数，
**             在底层驱动中毫秒延迟主要用于初始化，并不会影响实时性。
**	形    参 : _ulDelayTime - 延迟时间(ms)
**	返 回 值 : 无
**********************************************************************************************************/
void bsp_DelayMS(uint32_t _ulDelayTime)
{
    bsp_DelayUS(1000 * _ulDelayTime);
}

/**********************************************************************************************************
**	函 数 名: bsp_DelayUS
**	功能说明: 这里的延时采用CPU的内部计数实现(32位计数器)
**	形    参: _ulDelayTime - 延迟时间(us)
**	返 回 值: 无
**********************************************************************************************************/
void bsp_DelayUS(uint32_t _ulDelayTime)
{
    uint32_t tCnt, tDelayCnt;
    uint32_t tStart;

    tStart = DWT_CYCCNT;                                     	/* 初始计数器值 */
    tCnt = 0;
    tDelayCnt = _ulDelayTime * (HCLK_VALUE / 1000000);		    /* 需要的节拍数， 1us = (240MHz/10^6)/240MHz */

    while(tCnt < tDelayCnt)
    {
        tCnt = DWT_CYCCNT - tStart; 							/* 求减过程中，如果发生第一次32位计数器重新计数，依然可以正确计算 */
    }
}


/**********************************************************************************************************
**                                          End Of File
**********************************************************************************************************/
