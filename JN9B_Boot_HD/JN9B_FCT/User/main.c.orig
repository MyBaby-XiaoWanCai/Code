/**********************************************************************************************************
** Company     : JNE WuHan Co.,Ltd.
** Project     :
** --------------------------------------------------------------------------------------------------------
** File name   : main.c
** Author      : Huang Cheng
** Date        : 2021-11-22
** Description : RTX5 & HC32F4A0 Demo Project main file
**********************************************************************************************************/

/**********************************************************************************************************
**                                          头文件引用区
**********************************************************************************************************/
#include "hc32_ddl.h"
#include "bsp.h"
#include "main.h"

/**********************************************************************************************************
**                                         类型申明区
**********************************************************************************************************/


/**********************************************************************************************************
**                                         全局变量定义区
**********************************************************************************************************/


/**********************************************************************************************************
**                                           函数声明区
**********************************************************************************************************/

/**********************************************************************************************************
**                                           应用函数区
**********************************************************************************************************/
/**********************************************************************************************************
**  函 数 名 : EFM_FCT_Init()
**  功能说明 : 标准C程序入口
**  形    参 : 无
**  返 回 值 : 无
**********************************************************************************************************/
void EFM_FCT_Init(void)
{
    stc_efm_cfg_t stcEfmCfg;             //EFM配置结构体变量
    en_int_status_t flag1;               //flash0 ready flag
    en_int_status_t flag2;               //flash1 ready flag
    /* EFM default config. */
    (void)EFM_StructInit(&stcEfmCfg);     //还原默认EFM配置
    /*
     * Clock <= 40MHZ             EFM_WAIT_CYCLE_0
     * 40MHZ < Clock <= 80MHZ     EFM_WAIT_CYCLE_1
     * 80MHZ < Clock <= 120MHZ    EFM_WAIT_CYCLE_2
     * 120MHZ < Clock <= 160MHZ   EFM_WAIT_CYCLE_3
     * 160MHZ < Clock <= 200MHZ   EFM_WAIT_CYCLE_4
     * 200MHZ < Clock <= 240MHZ   EFM_WAIT_CYCLE_5
     */
    stcEfmCfg.u32WaitCycle = EFM_WAIT_CYCLE_5;   //根据当前系统时钟配置修改u32WaitCycle周期个数

    /* EFM config */
    (void)EFM_Init(&stcEfmCfg);                  //配置EFM寄存器组

    /* Wait flash0, flash1 ready. */             //等待flash0和flash1准备好
    do {
        flag1 = EFM_GetFlagStatus(EFM_FLAG_RDY0);
        flag2 = EFM_GetFlagStatus(EFM_FLAG_RDY1);
    } while((Set != flag1) || (Set != flag2));
}

/**********************************************************************************************************
**  函 数 名 : EFM_FCT_Erase()
**  功能说明 : 标准C程序入口
**  形    参 : 无
**  返 回 值 : 无
**********************************************************************************************************/
void EFM_FCT_Erase(void)
{
    en_result_t Erase_Flag;
    /* disables write protection */
    EFM_SectorCmd_Sequential(EFM_ADDR_SECTOR255, 1 ,Enable);      //关闭FCT扇区写保护
    do{
    __set_PRIMASK(1);                                             //关总中断
    Erase_Flag=EFM_SectorErase(EFM_ADDR_SECTOR255);               //擦除最后一个扇区
    Feed_WDG();                                                   //喂狗
     } while(Erase_Flag != Ok ); 
    __set_PRIMASK(0);                                             //开总中断
}

/**********************************************************************************************************
**  函 数 名 : main()
**  功能说明 : 标准C程序入口
**  形    参 : 无
**  返 回 值 : 无
**********************************************************************************************************/
int32_t main(void)
{    
    uint32_t RDate=0;
    uint32_t S_Auto_Test=0;
    uint32_t S_Failed_CNT=0;
    Peripheral_WE();                                      //外设寄存器写使能
    System_Init();                                        //系统和外设初始化
    EFM_FCT_Init();                                       //初始化EFM寄存器
    RDate=*(uint32_t *)(EFM_ADDR_SECTOR255);              //读看门狗测试开始标志
    S_Auto_Test=*(uint32_t *)(EFM_ADDR_SECTOR255+4);      //读自动测试标志
    S_Failed_CNT=*(uint32_t *)(EFM_ADDR_SECTOR255+8);     //读失败计数
    
    if(RDate==0xAAAABBBB)   //读到0xAAAABBBB,表示上次程序运行了看门狗测试
    {
		//检测是否是REST电平引起的复位，且不是掉电再上电引起复位
		if((bM4_RMU->RSTF0_b.PINRF)&&(!(bM4_RMU->RSTF0_b.PORF)))
		{
            printf("17.2 测试结果：PASS！\r\n");
            if(S_Auto_Test==0)
            {
            printf("17.3 测试结束，继续测试下一项！\r\n");
            }
            else 
            {                
            printf("――――――――主控板FCT测试流程结束！――――――――\r\n");
            printf("测试失败项总计：%d!\r\n",S_Failed_CNT);   
            }                
        }
        bM4_RMU->RSTF0_b.CLRF |= RMU_RSTF0_CLRF;                  //清除CLRF复位标志
        RDate=0xBBBBAAAA; 
        EFM_FCT_Erase();                                          //擦扇区
        EFM_SingleProgram(EFM_ADDR_SECTOR255 , RDate);            //写测试结束标志
        EFM_SectorCmd_Sequential(EFM_ADDR_SECTOR255, 1 ,Disable); //打开FCT扇区写保护
    }
    while(1);
}

/**********************************************************************************************************
**                                          End Of File
**********************************************************************************************************/
